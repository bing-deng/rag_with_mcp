<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿ - RAG Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .init-section {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .init-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .init-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .init-button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .init-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-display {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            transition: all 0.3s;
        }

        .status-display.show {
            display: block;
        }

        .status-display.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-display.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-display.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .chat-section {
            padding: 30px;
            display: none;
        }

        .chat-section.show {
            display: block;
        }

        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .message.assistant {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .sources {
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
            margin-top: 10px;
        }

        .message.assistant .sources {
            border-top-color: #eee;
            color: #666;
        }

        .input-section {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .question-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .question-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .ask-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ask-button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ask-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tech-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9rem;
        }

        .tech-stack {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tech-item {
            background: white;
            padding: 10px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .tech-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .example-questions {
            margin-top: 20px;
            text-align: center;
        }

        .example-questions h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1rem;
        }

        .example-button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-block;
        }

        .example-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            margin: 10px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.3;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .message {
                max-width: 95%;
            }
            
            .tech-stack {
                gap: 10px;
            }
            
            .system-stats {
                grid-template-columns: 1fr;
            }
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿ</h1>
            <p>åŸºäº AWS Claude + Cohere + Weaviate çš„é«˜çº§ RAG ç³»ç»Ÿ</p>
        </div>

        <div class="main-content">
            <div class="init-section" id="initSection">
                <h2>ğŸ“š ç³»ç»Ÿåˆå§‹åŒ–</h2>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆå§‹åŒ– RAG ç³»ç»Ÿï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŠ è½½ PDF æ–‡æ¡£å¹¶åˆ›å»ºæ™ºèƒ½å‘é‡æ•°æ®åº“</p>
                <br>
                <button class="init-button" id="initButton" onclick="initializeSystem()">
                    ğŸš€ å¯åŠ¨æ™ºèƒ½ç³»ç»Ÿ
                </button>
                
                <div class="status-display" id="statusDisplay">
                    <div id="statusMessage">å‡†å¤‡åˆå§‹åŒ–...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="example-questions">
                    <h4>ğŸ’¡ ç³»ç»Ÿåˆå§‹åŒ–åï¼Œæ‚¨å¯ä»¥è¯¢é—®è¿™äº›é—®é¢˜ï¼š</h4>
                    <button class="example-button">è¿™ä¸ªç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ</button>
                    <button class="example-button">å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ‰‹å†Œï¼Ÿ</button>
                    <button class="example-button">ç³»ç»Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼Ÿ</button>
                    <button class="example-button">æ“ä½œæ­¥éª¤æ˜¯æ€æ ·çš„ï¼Ÿ</button>
                    <button class="example-button">æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼Ÿ</button>
                    <button class="example-button">æ•…éšœæ’é™¤æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ</button>
                </div>
            </div>

            <div class="chat-section" id="chatSection">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">
                            ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½æ–‡æ¡£åŠ©æ‰‹ã€‚æˆ‘å·²ç»å­¦ä¹ äº†æ‚¨çš„PDFæ–‡æ¡£å†…å®¹ï¼Œç°åœ¨å¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šã€å‡†ç¡®çš„é—®ç­”æœåŠ¡ã€‚
                            <br><br>
                            ğŸ’¡ <strong>æˆ‘èƒ½åšä»€ä¹ˆï¼š</strong>
                            <br>â€¢ ğŸ“– åŸºäºæ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜
                            <br>â€¢ ğŸ” å¿«é€Ÿæ£€ç´¢ç›¸å…³ä¿¡æ¯
                            <br>â€¢ ğŸ’¬ æä¾›è¯¦ç»†çš„æ“ä½œæŒ‡å¯¼
                            <br>â€¢ ğŸ¯ é’ˆå¯¹æ€§çš„æŠ€æœ¯æ”¯æŒ
                            <br><br>
                            è¯·éšæ—¶å‘æˆ‘æé—®ï¼
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <input 
                        type="text" 
                        id="questionInput" 
                        class="question-input" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä¼šåŸºäºæ–‡æ¡£å†…å®¹ä¸ºæ‚¨è§£ç­”..." 
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="ask-button" id="askButton" onclick="askQuestion()">
                        ğŸ’¬ æé—®
                    </button>
                </div>

                <div class="system-stats" id="systemStats" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-number" id="docCount">0</div>
                        <div class="stat-label">æ–‡æ¡£ç‰‡æ®µ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="queryCount">0</div>
                        <div class="stat-label">æŸ¥è¯¢æ¬¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgResponse">0s</div>
                        <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
                    </div>
                </div>
            </div>

            <div class="tech-info">
                <div class="tech-stack">
                    <div class="tech-item">ğŸ§  AWS Claude 4</div>
                    <div class="tech-item">ğŸ“Š Cohere Embeddings</div>
                    <div class="tech-item">ğŸ—„ï¸ Weaviate Vector DB</div>
                    <div class="tech-item">ğŸŒ Flask + JavaScript</div>
                    <div class="tech-item">ğŸ“„ PDF Processing</div>
                    <div class="tech-item">ğŸ” Semantic Search</div>
                </div>
                <div style="text-align: center; margin-top: 15px; color: #888;">
                    <small>Powered by Advanced RAG Architecture | æ™ºèƒ½æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿ</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let isAsking = false;
        let queryCount = 0;
        let totalResponseTime = 0;

        function initializeSystem() {
            const button = document.getElementById('initButton');
            const statusDisplay = document.getElementById('statusDisplay');
            const statusMessage = document.getElementById('statusMessage');
            
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> æ­£åœ¨å¯åŠ¨...';
            
            statusDisplay.className = 'status-display show loading';
            statusMessage.textContent = 'ğŸš€ æ­£åœ¨å¯åŠ¨æ™ºèƒ½ç³»ç»Ÿ...';
            
            fetch('/api/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checkInitStatus();
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                showError('ç½‘ç»œè¿æ¥é”™è¯¯: ' + error.message);
            });
        }

        function checkInitStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const statusDisplay = document.getElementById('statusDisplay');
                const statusMessage = document.getElementById('statusMessage');
                const progressFill = document.getElementById('progressFill');
                const button = document.getElementById('initButton');
                
                progressFill.style.width = data.progress + '%';
                statusMessage.textContent = data.message;
                
                if (data.status === 'completed') {
                    statusDisplay.className = 'status-display show success';
                    statusMessage.innerHTML = 'âœ… ' + data.message + '<br>ğŸ‰ ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹æ‚¨çš„æ™ºèƒ½é—®ç­”ä¹‹æ—…ï¼';
                    button.innerHTML = 'âœ… ç³»ç»Ÿå·²å°±ç»ª';
                    isInitialized = true;
                    
                    setTimeout(() => {
                        document.getElementById('initSection').style.display = 'none';
                        document.getElementById('chatSection').className = 'chat-section show';
                        document.getElementById('systemStats').style.display = 'grid';
                        document.getElementById('questionInput').focus();
                    }, 3000);
                    
                } else if (data.status === 'error') {
                    statusDisplay.className = 'status-display show error';
                    statusMessage.innerHTML = 'âŒ ' + data.message + '<br>è¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®åé‡è¯•';
                    button.disabled = false;
                    button.innerHTML = 'ğŸ”„ é‡æ–°åˆå§‹åŒ–';
                    
                } else {
                    // ç»§ç»­æ£€æŸ¥çŠ¶æ€
                    setTimeout(checkInitStatus, 2000);
                }
            })
            .catch(error => {
                showError('çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message);
            });
        }

        function showError(message) {
            const statusDisplay = document.getElementById('statusDisplay');
            const statusMessage = document.getElementById('statusMessage');
            const button = document.getElementById('initButton');
            
            statusDisplay.className = 'status-display show error';
            statusMessage.innerHTML = 'âŒ ' + message;
            button.disabled = false;
            button.innerHTML = 'ğŸ”„ é‡æ–°åˆå§‹åŒ–';
        }

        function askQuestion() {
            if (!isInitialized || isAsking) return;
            
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                input.focus();
                return;
            }
            
            const button = document.getElementById('askButton');
            const chatContainer = document.getElementById('chatContainer');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', question);
            
            // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            const typingIndicator = addTypingIndicator();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            isAsking = true;
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> AIæ€è€ƒä¸­...';
            
            const startTime = Date.now();
            
            // å‘é€è¯·æ±‚
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                if (data.success) {
                    const result = data.data;
                    let sourcesText = '';
                    
                    if (result.sources && result.sources.length > 0) {
                        sourcesText = `\n\nğŸ“š å‚è€ƒäº† ${result.source_count} ä¸ªæ–‡æ¡£ç‰‡æ®µï¼Œç½®ä¿¡åº¦è¾ƒé«˜`;
                    }
                    
                    addMessage('assistant', result.answer + sourcesText);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateStats(startTime);
                } else {
                    addMessage('assistant', 'âŒ ' + data.message);
                }
            })
            .catch(error => {
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                addMessage('assistant', 'âŒ ç½‘ç»œè¿æ¥é”™è¯¯: ' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
            })
            .finally(() => {
                isAsking = false;
                button.disabled = false;
                button.innerHTML = 'ğŸ’¬ æé—®';
                input.focus();
            });
        }

        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant typing-message';
            
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'typing-indicator';
            indicatorDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            typingDiv.appendChild(indicatorDiv);
            chatContainer.appendChild(typingDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return typingDiv;
        }

        function formatMessage(text) {
            // æ ¼å¼åŒ–æ¶ˆæ¯ï¼šæ¢è¡Œã€åŠ ç²—ç­‰
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function updateStats(startTime) {
            queryCount++;
            const responseTime = (Date.now() - startTime) / 1000;
            totalResponseTime += responseTime;
            const avgResponseTime = totalResponseTime / queryCount;
            
            document.getElementById('queryCount').textContent = queryCount;
            document.getElementById('avgResponse').textContent = avgResponseTime.toFixed(1) + 's';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                askQuestion();
            }
        }

        // ç¤ºä¾‹é—®é¢˜ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const exampleButtons = document.querySelectorAll('.example-button');
            exampleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (isInitialized) {
                        document.getElementById('questionInput').value = this.textContent;
                        document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });
                        setTimeout(() => {
                            document.getElementById('questionInput').focus();
                        }, 500);
                    }
                });
            });
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.addEventListener('load', function() {
            fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                if (data.rag_ready) {
                    isInitialized = true;
                    document.getElementById('initSection').style.display = 'none';
                    document.getElementById('chatSection').className = 'chat-section show';
                    document.getElementById('systemStats').style.display = 'grid';
                }
            })
            .catch(error => {
                console.log('ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥:', error);
            });
        });

        // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function() {
            // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
            const questionInput = document.getElementById('questionInput');
            questionInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
            });
            
            questionInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });
    </script>
</body>
</html> 