<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能文档问答系统 - RAG Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .init-section {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .init-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .init-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .init-button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .init-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-display {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            transition: all 0.3s;
        }

        .status-display.show {
            display: block;
        }

        .status-display.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-display.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-display.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .chat-section {
            padding: 30px;
            display: none;
        }

        .chat-section.show {
            display: block;
        }

        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .message.assistant {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .sources {
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
            margin-top: 10px;
        }

        .message.assistant .sources {
            border-top-color: #eee;
            color: #666;
        }

        .input-section {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .question-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .question-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .ask-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ask-button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ask-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tech-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9rem;
        }

        .tech-stack {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tech-item {
            background: white;
            padding: 10px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .tech-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .example-questions {
            margin-top: 20px;
            text-align: center;
        }

        .example-questions h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1rem;
        }

        .example-button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-block;
        }

        .example-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            margin: 10px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.3;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .message {
                max-width: 95%;
            }
            
            .tech-stack {
                gap: 10px;
            }
            
            .system-stats {
                grid-template-columns: 1fr;
            }
        }

        /* 美化滚动条 */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 智能文档问答系统</h1>
            <p>基于 AWS Claude + Cohere + Weaviate 的高级 RAG 系统</p>
        </div>

        <div class="main-content">
            <div class="init-section" id="initSection">
                <h2>📚 系统初始化</h2>
                <p>点击下方按钮初始化 RAG 系统，系统将自动加载 PDF 文档并创建智能向量数据库</p>
                <br>
                <button class="init-button" id="initButton" onclick="initializeSystem()">
                    🚀 启动智能系统
                </button>
                
                <div class="status-display" id="statusDisplay">
                    <div id="statusMessage">准备初始化...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="example-questions">
                    <h4>💡 系统初始化后，您可以询问这些问题：</h4>
                    <button class="example-button">这个系统的主要功能是什么？</button>
                    <button class="example-button">如何使用这个手册？</button>
                    <button class="example-button">系统有什么特点和优势？</button>
                    <button class="example-button">操作步骤是怎样的？</button>
                    <button class="example-button">有哪些注意事项？</button>
                    <button class="example-button">故障排除方法有哪些？</button>
                </div>
            </div>

            <div class="chat-section" id="chatSection">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">
                            👋 您好！我是您的智能文档助手。我已经学习了您的PDF文档内容，现在可以为您提供专业、准确的问答服务。
                            <br><br>
                            💡 <strong>我能做什么：</strong>
                            <br>• 📖 基于文档内容回答问题
                            <br>• 🔍 快速检索相关信息
                            <br>• 💬 提供详细的操作指导
                            <br>• 🎯 针对性的技术支持
                            <br><br>
                            请随时向我提问！
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <input 
                        type="text" 
                        id="questionInput" 
                        class="question-input" 
                        placeholder="请输入您的问题，我会基于文档内容为您解答..." 
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="ask-button" id="askButton" onclick="askQuestion()">
                        💬 提问
                    </button>
                </div>

                <div class="system-stats" id="systemStats" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-number" id="docCount">0</div>
                        <div class="stat-label">文档片段</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="queryCount">0</div>
                        <div class="stat-label">查询次数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgResponse">0s</div>
                        <div class="stat-label">平均响应时间</div>
                    </div>
                </div>
            </div>

            <div class="tech-info">
                <div class="tech-stack">
                    <div class="tech-item">🧠 AWS Claude 4</div>
                    <div class="tech-item">📊 Cohere Embeddings</div>
                    <div class="tech-item">🗄️ Weaviate Vector DB</div>
                    <div class="tech-item">🌐 Flask + JavaScript</div>
                    <div class="tech-item">📄 PDF Processing</div>
                    <div class="tech-item">🔍 Semantic Search</div>
                </div>
                <div style="text-align: center; margin-top: 15px; color: #888;">
                    <small>Powered by Advanced RAG Architecture | 智能检索增强生成系统</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let isAsking = false;
        let queryCount = 0;
        let totalResponseTime = 0;

        function initializeSystem() {
            const button = document.getElementById('initButton');
            const statusDisplay = document.getElementById('statusDisplay');
            const statusMessage = document.getElementById('statusMessage');
            
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> 正在启动...';
            
            statusDisplay.className = 'status-display show loading';
            statusMessage.textContent = '🚀 正在启动智能系统...';
            
            fetch('/api/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checkInitStatus();
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                showError('网络连接错误: ' + error.message);
            });
        }

        function checkInitStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const statusDisplay = document.getElementById('statusDisplay');
                const statusMessage = document.getElementById('statusMessage');
                const progressFill = document.getElementById('progressFill');
                const button = document.getElementById('initButton');
                
                progressFill.style.width = data.progress + '%';
                statusMessage.textContent = data.message;
                
                if (data.status === 'completed') {
                    statusDisplay.className = 'status-display show success';
                    statusMessage.innerHTML = '✅ ' + data.message + '<br>🎉 系统已准备就绪，开始您的智能问答之旅！';
                    button.innerHTML = '✅ 系统已就绪';
                    isInitialized = true;
                    
                    setTimeout(() => {
                        document.getElementById('initSection').style.display = 'none';
                        document.getElementById('chatSection').className = 'chat-section show';
                        document.getElementById('systemStats').style.display = 'grid';
                        document.getElementById('questionInput').focus();
                    }, 3000);
                    
                } else if (data.status === 'error') {
                    statusDisplay.className = 'status-display show error';
                    statusMessage.innerHTML = '❌ ' + data.message + '<br>请检查系统配置后重试';
                    button.disabled = false;
                    button.innerHTML = '🔄 重新初始化';
                    
                } else {
                    // 继续检查状态
                    setTimeout(checkInitStatus, 2000);
                }
            })
            .catch(error => {
                showError('状态检查失败: ' + error.message);
            });
        }

        function showError(message) {
            const statusDisplay = document.getElementById('statusDisplay');
            const statusMessage = document.getElementById('statusMessage');
            const button = document.getElementById('initButton');
            
            statusDisplay.className = 'status-display show error';
            statusMessage.innerHTML = '❌ ' + message;
            button.disabled = false;
            button.innerHTML = '🔄 重新初始化';
        }

        function askQuestion() {
            if (!isInitialized || isAsking) return;
            
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) {
                input.focus();
                return;
            }
            
            const button = document.getElementById('askButton');
            const chatContainer = document.getElementById('chatContainer');
            
            // 添加用户消息
            addMessage('user', question);
            
            // 添加加载指示器
            const typingIndicator = addTypingIndicator();
            
            // 清空输入框
            input.value = '';
            
            // 设置按钮状态
            isAsking = true;
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> AI思考中...';
            
            const startTime = Date.now();
            
            // 发送请求
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            })
            .then(response => response.json())
            .then(data => {
                // 移除加载指示器
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                if (data.success) {
                    const result = data.data;
                    let sourcesText = '';
                    
                    if (result.sources && result.sources.length > 0) {
                        sourcesText = `\n\n📚 参考了 ${result.source_count} 个文档片段，置信度较高`;
                    }
                    
                    addMessage('assistant', result.answer + sourcesText);
                    
                    // 更新统计信息
                    updateStats(startTime);
                } else {
                    addMessage('assistant', '❌ ' + data.message);
                }
            })
            .catch(error => {
                // 移除加载指示器
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                addMessage('assistant', '❌ 网络连接错误: ' + error.message + '\n\n请检查网络连接后重试。');
            })
            .finally(() => {
                isAsking = false;
                button.disabled = false;
                button.innerHTML = '💬 提问';
                input.focus();
            });
        }

        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant typing-message';
            
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'typing-indicator';
            indicatorDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            typingDiv.appendChild(indicatorDiv);
            chatContainer.appendChild(typingDiv);
            
            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return typingDiv;
        }

        function formatMessage(text) {
            // 格式化消息：换行、加粗等
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function updateStats(startTime) {
            queryCount++;
            const responseTime = (Date.now() - startTime) / 1000;
            totalResponseTime += responseTime;
            const avgResponseTime = totalResponseTime / queryCount;
            
            document.getElementById('queryCount').textContent = queryCount;
            document.getElementById('avgResponse').textContent = avgResponseTime.toFixed(1) + 's';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                askQuestion();
            }
        }

        // 示例问题点击事件
        document.addEventListener('DOMContentLoaded', function() {
            const exampleButtons = document.querySelectorAll('.example-button');
            exampleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (isInitialized) {
                        document.getElementById('questionInput').value = this.textContent;
                        document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });
                        setTimeout(() => {
                            document.getElementById('questionInput').focus();
                        }, 500);
                    }
                });
            });
        });

        // 页面加载时检查系统状态
        window.addEventListener('load', function() {
            fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                if (data.rag_ready) {
                    isInitialized = true;
                    document.getElementById('initSection').style.display = 'none';
                    document.getElementById('chatSection').className = 'chat-section show';
                    document.getElementById('systemStats').style.display = 'grid';
                }
            })
            .catch(error => {
                console.log('系统健康检查失败:', error);
            });
        });

        // 添加一些交互效果
        document.addEventListener('DOMContentLoaded', function() {
            // 输入框焦点效果
            const questionInput = document.getElementById('questionInput');
            questionInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
            });
            
            questionInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });
    </script>
</body>
</html> 