<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿ Web UI</title>
    <!-- DaisyUI + Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown æ¸²æŸ“æ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/es/highlight.min.js"></script>
    <!-- HTTP è¯·æ±‚åº“ -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        /* æ·±è‰²æ¨¡å¼ä¼˜åŒ– */
        [data-theme="dark"] {
            --primary: #ffffff;
            --primary-content: #000000;
            --secondary: #6b7280;
            --secondary-content: #ffffff;
            --accent: #ffffff;
            --accent-content: #000000;
            --neutral: #374151;
            --neutral-content: #ffffff;
            --base-100: #1f2937;
            --base-200: #111827;
            --base-300: #030712;
            --base-content: #ffffff;
        }
        
        /* å¢å¼ºå¯¹æ¯”åº¦ */
        .high-contrast {
            border: 2px solid #ffffff;
        }
        
        /* ä»£ç å—æ ·å¼ä¼˜åŒ– */
        .prose pre {
            background-color: #000000 !important;
            border: 1px solid #374151;
        }
        
        .prose code {
            background-color: #374151 !important;
            color: #ffffff !important;
        }
        
        /* èŠå¤©æ°”æ³¡ä¼˜åŒ– */
        .chat-bubble-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #ffffff;
        }
        
        .chat-bubble-secondary {
            background-color: #374151 !important;
            color: #ffffff !important;
            border: 1px solid #6b7280;
        }
        
        /* æŒ‰é’®å¢å¼ºå¯¹æ¯” */
        .btn-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #ffffff !important;
        }
        
        .btn-primary:hover {
            background-color: #f3f4f6 !important;
            color: #000000 !important;
        }
        
        .btn-secondary {
            background-color: #6b7280 !important;
            color: #ffffff !important;
            border: 2px solid #6b7280 !important;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563 !important;
            color: #ffffff !important;
        }
        
        /* å¡ç‰‡è¾¹æ¡†å¢å¼º */
        .card {
            border: 1px solid #374151;
        }
        
        /* è¾“å…¥æ¡†ä¼˜åŒ– */
        .input-bordered {
            border: 2px solid #6b7280 !important;
            background-color: #1f2937 !important;
            color: #ffffff !important;
        }
        
        .input-bordered:focus {
            border-color: #ffffff !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2) !important;
        }
        
        /* é€‰æ‹©æ¡†ä¼˜åŒ– */
        .select-bordered {
            border: 2px solid #6b7280 !important;
            background-color: #1f2937 !important;
            color: #ffffff !important;
        }
        
        /* Badge ä¼˜åŒ– */
        .badge-outline {
            border: 1px solid #6b7280 !important;
            color: #ffffff !important;
        }
        
        .badge-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <!-- Navigation Bar -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path>
                    </svg>
                </div>
            </div>
            <a class="btn btn-ghost text-xl">ğŸ§  æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿ</a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <p class="text-sm text-base-content/70">æ”¯æŒå‘é‡æœç´¢å’ŒAIæ™ºèƒ½é—®ç­”</p>
        </div>
        <div class="navbar-end">
            <!-- ä¸»é¢˜åˆ‡æ¢ -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                    <li><a onclick="setTheme('dark')" class="font-bold">ğŸŒ™ æ·±è‰²æ¨¡å¼ (æ¨è)</a></li>
                    <li><a onclick="setTheme('light')">ğŸŒ æµ…è‰²æ¨¡å¼</a></li>
                    <li><a onclick="setTheme('business')">ğŸ’¼ å•†åŠ¡é»‘</a></li>
                    <li><a onclick="setTheme('night')">ğŸŒŒ å¤œæ™šæ¨¡å¼</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- é›†åˆé€‰æ‹©å¡ç‰‡ -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">
                    <i data-lucide="database"></i>
                    é€‰æ‹©æ•°æ®é›†åˆ
                </h2>
                <div class="flex flex-wrap gap-2 mt-4" id="collections-container">
                    <div class="skeleton h-10 w-32"></div>
                    <div class="skeleton h-10 w-32"></div>
                </div>
                <div class="alert alert-info mt-4" id="collection-info" style="display: none;">
                    <i data-lucide="info"></i>
                    <span id="collection-details">è¯·é€‰æ‹©ä¸€ä¸ªé›†åˆ</span>
                </div>
            </div>
        </div>

        <!-- æŸ¥è¯¢æ¨¡å¼é€‰æ‹© -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- å‘é‡æœç´¢æ¨¡å¼ -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer" 
                 onclick="setMode('vector')" id="vector-mode-card">
                <div class="card-body">
                    <h2 class="card-title text-primary">
                        <i data-lucide="search"></i>
                        å‘é‡æœç´¢
                    </h2>
                    <p class="text-base-content/70">å¿«é€Ÿç²¾ç¡®çš„ç›¸ä¼¼æ€§æ£€ç´¢ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„å†…å®¹</p>
                    <div class="card-actions justify-end">
                        <div class="badge badge-primary badge-outline">å¿«é€Ÿ</div>
                        <div class="badge badge-primary badge-outline">ç²¾ç¡®</div>
                    </div>
                </div>
            </div>

            <!-- AIé—®ç­”æ¨¡å¼ -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer" 
                 onclick="setMode('llama')" id="llama-mode-card">
                <div class="card-body">
                    <h2 class="card-title text-secondary">
                        <i data-lucide="bot"></i>
                        AIé—®ç­”
                    </h2>
                    <p class="text-base-content/70">è‡ªç„¶è¯­è¨€æ™ºèƒ½å¯¹è¯ï¼Œè·å¾—è¯¦ç»†çš„ç­”æ¡ˆè§£é‡Š</p>
                    <div class="card-actions justify-end">
                        <div class="badge badge-secondary badge-outline">æ™ºèƒ½</div>
                        <div class="badge badge-secondary badge-outline">è¯¦ç»†</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŸ¥è¯¢ç•Œé¢ -->
        <div class="card bg-base-100 shadow-xl" id="query-interface" style="display: none;">
            <!-- å‘é‡æœç´¢ç•Œé¢ -->
            <div id="vector-search" style="display: none;">
                <div class="card-body">
                    <h2 class="card-title text-primary">
                        <i data-lucide="search"></i>
                        å‘é‡æœç´¢
                    </h2>
                    
                    <!-- æœç´¢è¾“å…¥ -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">æœç´¢å†…å®¹</span>
                        </label>
                        <input type="text" id="vector-query" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." 
                               class="input input-bordered input-primary w-full" />
                    </div>

                    <!-- é«˜çº§é€‰é¡¹ -->
                    <div class="collapse collapse-arrow bg-base-200 mt-4">
                        <input type="checkbox" />
                        <div class="collapse-title text-sm font-medium">
                            <i data-lucide="settings"></i>
                            é«˜çº§æœç´¢é€‰é¡¹
                        </div>
                        <div class="collapse-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">å†…å®¹ç±»å‹</span>
                                    </label>
                                    <select id="content-type" class="select select-bordered">
                                        <option value="">æ‰€æœ‰ç±»å‹</option>
                                        <option value="paragraph">æ®µè½</option>
                                        <option value="heading_h1">ä¸€çº§æ ‡é¢˜</option>
                                        <option value="heading_h2">äºŒçº§æ ‡é¢˜</option>
                                        <option value="heading_h3">ä¸‰çº§æ ‡é¢˜</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">æœ€å°å­—æ•°</span>
                                    </label>
                                    <input type="number" id="min-words" placeholder="å¦‚: 10" 
                                           class="input input-bordered" />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">ç»“æœæ•°é‡</span>
                                    </label>
                                    <select id="top-k" class="select select-bordered">
                                        <option value="5">5æ¡</option>
                                        <option value="10">10æ¡</option>
                                        <option value="20">20æ¡</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-actions justify-center mt-6">
                        <button onclick="vectorSearch()" class="btn btn-primary btn-wide">
                            <i data-lucide="search"></i>
                            å¼€å§‹æœç´¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- AIé—®ç­”ç•Œé¢ -->
            <div id="llama-chat" style="display: none;">
                <div class="card-body">
                    <h2 class="card-title text-secondary">
                        <i data-lucide="bot"></i>
                        AIæ™ºèƒ½é—®ç­”
                    </h2>
                    
                    <!-- èŠå¤©å†å² -->
                    <div class="bg-base-200 rounded-lg p-4 h-96 overflow-y-auto mb-4" id="chat-history">
                        <div class="flex items-center justify-center h-full text-base-content/50">
                            <div class="text-center">
                                <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>å¼€å§‹æ‚¨çš„æ™ºèƒ½é—®ç­”...</p>
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥æ¡† -->
                    <div class="join w-full">
                        <input type="text" id="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                               class="input input-bordered input-secondary join-item flex-1"
                               onkeypress="if(event.key==='Enter') chatQuery()" />
                        <button onclick="chatQuery()" class="btn btn-secondary join-item">
                            <i data-lucide="send"></i>
                            å‘é€
                        </button>
                    </div>

                    <!-- å¿«æ·é—®é¢˜ -->
                    <div class="mt-4">
                        <div class="label">
                            <span class="label-text">å¿«æ·é—®é¢˜ï¼š</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('é–¢é›»å·¥å…¬å¸ä¿¡æ¯')">é–¢é›»å·¥å…¬å¸ä¿¡æ¯</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('ä¸»è¦ä¸šåŠ¡é¢†åŸŸ')">ä¸»è¦ä¸šåŠ¡é¢†åŸŸ</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('å…¬å¸å†å²')">å…¬å¸å†å²</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('è”ç³»æ–¹å¼')">è”ç³»æ–¹å¼</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div class="card bg-base-100 shadow-xl mt-6" id="results-container" style="display: none;">
            <div class="card-body">
                <h2 class="card-title">
                    <i data-lucide="file-text"></i>
                    æŸ¥è¯¢ç»“æœ
                </h2>
                <div id="results-content"></div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æ¨¡æ€æ¡† -->
    <dialog id="loading-modal" class="modal">
        <div class="modal-box text-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
            <h3 class="font-bold text-lg mt-4">å¤„ç†ä¸­...</h3>
            <p class="py-4">è¯·ç¨ç­‰ï¼Œæ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢ä¿¡æ¯</p>
        </div>
    </dialog>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div class="toast toast-top toast-end" id="toast-container"></div>

    <script>
        let currentCollection = null;
        let currentMode = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ– Lucide å›¾æ ‡
            lucide.createIcons();
            
            // åŠ è½½é›†åˆåˆ—è¡¨
            loadCollections();
            
            // é…ç½® marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
        };

        // ä¸»é¢˜åˆ‡æ¢
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            showToast('ä¸»é¢˜å·²åˆ‡æ¢åˆ° ' + theme, 'success');
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸»é¢˜ï¼Œé»˜è®¤ä¸ºæ·±è‰²æ¨¡å¼
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if (!localStorage.getItem('theme')) {
            localStorage.setItem('theme', 'dark');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg`;
            toast.innerHTML = `
                <div>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // åŠ è½½é›†åˆåˆ—è¡¨
        async function loadCollections() {
            try {
                const response = await axios.get('/api/collections');
                const collections = response.data.collections;
                const container = document.getElementById('collections-container');
                
                if (collections.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning"><span>æœªæ‰¾åˆ°å¯ç”¨é›†åˆ</span></div>';
                    return;
                }

                container.innerHTML = collections.map(name => 
                    `<button onclick="selectCollection('${name}')" 
                             class="btn btn-outline collection-btn" data-collection="${name}">
                        <i data-lucide="database"></i>
                        ${name}
                    </button>`
                ).join('');

                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                lucide.createIcons();

                // ä¼˜å…ˆé€‰æ‹©åŒ…å«é–¢é›»å·¥æ•°æ®çš„é›†åˆ
                const preferredCollections = ['kandenko_website_smart', 'kandenko_website'];
                let selectedCollection = null;
                
                for (const preferred of preferredCollections) {
                    if (collections.includes(preferred)) {
                        selectedCollection = preferred;
                        break;
                    }
                }
                
                if (selectedCollection) {
                    selectCollection(selectedCollection);
                } else if (collections.length === 1) {
                    selectCollection(collections[0]);
                }
            } catch (error) {
                console.error('åŠ è½½é›†åˆå¤±è´¥:', error);
                document.getElementById('collections-container').innerHTML = 
                    '<div class="alert alert-error"><span>åŠ è½½é›†åˆå¤±è´¥</span></div>';
            }
        }

        // é€‰æ‹©é›†åˆ
        async function selectCollection(collectionName) {
            currentCollection = collectionName;
            
            // æ›´æ–°UI
            document.querySelectorAll('.collection-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            document.querySelector(`[data-collection="${collectionName}"]`).classList.remove('btn-outline');
            document.querySelector(`[data-collection="${collectionName}"]`).classList.add('btn-primary');

            // è·å–é›†åˆä¿¡æ¯
            try {
                const response = await axios.get(`/api/collections/${collectionName}/stats`);
                const stats = response.data;
                
                document.getElementById('collection-details').innerHTML = 
                    `å·²é€‰æ‹©: <strong>${collectionName}</strong> | è®°å½•æ•°: ${stats.total_records} | ç»´åº¦: ${stats.dimension}`;
                document.getElementById('collection-info').style.display = 'flex';
                
                showToast(`å·²é€‰æ‹©é›†åˆ: ${collectionName}`, 'success');
            } catch (error) {
                console.error('è·å–é›†åˆä¿¡æ¯å¤±è´¥:', error);
                showToast('è·å–é›†åˆä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // è®¾ç½®æŸ¥è¯¢æ¨¡å¼
        function setMode(mode) {
            if (!currentCollection) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé›†åˆ', 'warning');
                return;
            }

            currentMode = mode;
            
            // é‡ç½®å¡ç‰‡æ ·å¼
            document.getElementById('vector-mode-card').classList.remove('bg-primary', 'text-primary-content');
            document.getElementById('llama-mode-card').classList.remove('bg-secondary', 'text-secondary-content');
            
            if (mode === 'vector') {
                document.getElementById('vector-mode-card').classList.add('bg-primary', 'text-primary-content');
                document.getElementById('vector-search').style.display = 'block';
                document.getElementById('llama-chat').style.display = 'none';
                showToast('å·²åˆ‡æ¢åˆ°å‘é‡æœç´¢æ¨¡å¼', 'info');
            } else {
                document.getElementById('llama-mode-card').classList.add('bg-secondary', 'text-secondary-content');
                document.getElementById('vector-search').style.display = 'none';
                document.getElementById('llama-chat').style.display = 'block';
                showToast('å·²åˆ‡æ¢åˆ°AIé—®ç­”æ¨¡å¼', 'info');
            }
            
            document.getElementById('query-interface').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
        }

        // å‘é‡æœç´¢
        async function vectorSearch() {
            const query = document.getElementById('vector-query').value.trim();
            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å†…å®¹', 'warning');
                return;
            }

            showLoading(true);
            
            try {
                const params = {
                    query: query,
                    collection_name: currentCollection,
                    content_type: document.getElementById('content-type').value || null,
                    min_words: document.getElementById('min-words').value || null,
                    top_k: parseInt(document.getElementById('top-k').value)
                };

                const response = await axios.post('/api/vector-search', params);
                displayVectorResults(response.data.results);
                showToast(`æ‰¾åˆ° ${response.data.results.length} æ¡ç›¸å…³ç»“æœ`, 'success');
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showToast('æœç´¢å¤±è´¥: ' + (error.response?.data?.error || error.message), 'error');
            } finally {
                showLoading(false);
            }
        }

        // AIé—®ç­”
        async function chatQuery() {
            const question = document.getElementById('chat-input').value.trim();
            if (!question) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²
            addChatMessage('user', question);
            document.getElementById('chat-input').value = '';

            showLoading(true);

            try {
                const response = await axios.post('/api/llama-chat', {
                    question: question,
                    collection_name: currentCollection
                });

                addChatMessage('assistant', response.data.answer, response.data.sources);
            } catch (error) {
                console.error('AIé—®ç­”å¤±è´¥:', error);
                addChatMessage('assistant', 'æŠ±æ­‰ï¼ŒAIé—®ç­”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: ' + (error.response?.data?.error || error.message));
            } finally {
                showLoading(false);
            }
        }

        // å¿«æ·é—®é¢˜
        function askQuestion(question) {
            document.getElementById('chat-input').value = question;
            chatQuery();
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯ - æ”¯æŒ Markdown
        function addChatMessage(role, content, sources = null) {
            const chatHistory = document.getElementById('chat-history');
            
            // æ¸…ç©ºå ä½ç¬¦
            const placeholder = chatHistory.querySelector('.flex.items-center.justify-center');
            if (placeholder) placeholder.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat ${role === 'user' ? 'chat-end' : 'chat-start'}`;
            
            let html = `
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full ${role === 'user' ? 'bg-primary' : 'bg-secondary'}">
                        <div class="flex items-center justify-center h-full text-white">
                            ${role === 'user' ? '<i data-lucide="user"></i>' : '<i data-lucide="bot"></i>'}
                        </div>
                    </div>
                </div>
                <div class="chat-header">
                    ${role === 'user' ? 'æ‚¨' : 'AIåŠ©æ‰‹'}
                    <time class="text-xs opacity-50">${new Date().toLocaleTimeString()}</time>
                </div>
                <div class="chat-bubble ${role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-secondary'}">
                    <div class="prose prose-sm max-w-none text-inherit">
                        ${marked.parse(content)}
                    </div>
            `;
            
            if (sources && sources.length > 0) {
                html += `
                    <div class="collapse collapse-arrow mt-2">
                        <input type="checkbox" />
                        <div class="collapse-title text-xs opacity-75 p-0">
                            <i data-lucide="link"></i>
                            å‚è€ƒæ¥æº (${sources.length})
                        </div>
                        <div class="collapse-content p-0 pt-2">
                            <div class="text-xs space-y-1">
                `;
                sources.forEach((source, i) => {
                    const title = source.title.substring(0, 50) + (source.title.length > 50 ? '...' : '');
                    const url = source.url || '#';
                    html += `
                        <div class="flex items-center gap-2 p-1 rounded bg-base-100/20">
                            <span class="badge badge-xs">${i+1}</span>
                            <span class="badge badge-outline badge-xs">${source.content_type}</span>
                            ${url && url !== '#' && url !== '' ? 
                                `<a href="${url}" target="_blank" class="link link-hover flex-1 truncate">${title}</a>` : 
                                `<span class="flex-1 truncate">${title}</span>`}
                            <span class="text-xs opacity-60">${source.similarity.toFixed(3)}</span>
                        </div>
                    `;
                });
                html += '</div></div></div>';
            }
            
            html += '</div>';
            messageDiv.innerHTML = html;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
            lucide.createIcons();
        }

        // æ˜¾ç¤ºå‘é‡æœç´¢ç»“æœ
        function displayVectorResults(results) {
            const container = document.getElementById('results-content');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><span>æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</span></div>';
            } else {
                container.innerHTML = results.map((result, i) => `
                    <div class="card bg-base-200 shadow mb-4">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="card-title text-lg">
                                    <span class="badge badge-neutral">${i + 1}</span>
                                    ${result.title || 'æ— æ ‡é¢˜'}
                                </h3>
                                <div class="badge badge-primary">${result.distance?.toFixed(3) || 'N/A'}</div>
                            </div>
                            
                            <div class="flex gap-2 mb-3">
                                <div class="badge badge-outline">${result.content_type || 'N/A'}</div>
                                ${result.url && result.url !== '#' && result.url !== '' ? 
                                    `<a href="${result.url}" target="_blank" class="badge badge-info badge-outline">
                                        <i data-lucide="external-link" class="w-3 h-3 mr-1"></i>
                                        æŸ¥çœ‹åŸæ–‡
                                    </a>` : ''}
                            </div>
                            
                            <div class="prose prose-sm max-w-none">
                                ${marked.parse(result.content?.substring(0, 300) || 'æ— å†…å®¹')}
                                ${result.content?.length > 300 ? '<p class="text-base-content/50">...</p>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                lucide.createIcons();
            }
            
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }

        // æ˜¾ç¤º/éšè—åŠ è½½æ¨¡æ€æ¡†
        function showLoading(show) {
            const modal = document.getElementById('loading-modal');
            if (show) {
                modal.showModal();
            } else {
                modal.close();
            }
        }
    </script>
</body>
</html>