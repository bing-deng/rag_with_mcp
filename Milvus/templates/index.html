<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能查询系统 Web UI</title>
    <!-- DaisyUI + Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown 渲染支持 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 代码高亮 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/es/highlight.min.js"></script>
    <!-- HTTP 请求库 -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <!-- 自定义样式 -->
    <style>
        /* 深色模式优化 */
        [data-theme="dark"] {
            --primary: #ffffff;
            --primary-content: #000000;
            --secondary: #6b7280;
            --secondary-content: #ffffff;
            --accent: #ffffff;
            --accent-content: #000000;
            --neutral: #374151;
            --neutral-content: #ffffff;
            --base-100: #1f2937;
            --base-200: #111827;
            --base-300: #030712;
            --base-content: #ffffff;
        }
        
        /* 增强对比度 */
        .high-contrast {
            border: 2px solid #ffffff;
        }
        
        /* 代码块样式优化 */
        .prose pre {
            background-color: #000000 !important;
            border: 1px solid #374151;
        }
        
        .prose code {
            background-color: #374151 !important;
            color: #ffffff !important;
        }
        
        /* 聊天气泡优化 */
        .chat-bubble-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #ffffff;
        }
        
        .chat-bubble-secondary {
            background-color: #374151 !important;
            color: #ffffff !important;
            border: 1px solid #6b7280;
        }
        
        /* 按钮增强对比 */
        .btn-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 2px solid #ffffff !important;
        }
        
        .btn-primary:hover {
            background-color: #f3f4f6 !important;
            color: #000000 !important;
        }
        
        .btn-secondary {
            background-color: #6b7280 !important;
            color: #ffffff !important;
            border: 2px solid #6b7280 !important;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563 !important;
            color: #ffffff !important;
        }
        
        /* 卡片边框增强 */
        .card {
            border: 1px solid #374151;
        }
        
        /* 输入框优化 */
        .input-bordered {
            border: 2px solid #6b7280 !important;
            background-color: #1f2937 !important;
            color: #ffffff !important;
        }
        
        .input-bordered:focus {
            border-color: #ffffff !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2) !important;
        }
        
        /* 选择框优化 */
        .select-bordered {
            border: 2px solid #6b7280 !important;
            background-color: #1f2937 !important;
            color: #ffffff !important;
        }
        
        /* Badge 优化 */
        .badge-outline {
            border: 1px solid #6b7280 !important;
            color: #ffffff !important;
        }
        
        .badge-primary {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <!-- Navigation Bar -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path>
                    </svg>
                </div>
            </div>
            <a class="btn btn-ghost text-xl">🧠 智能查询系统</a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <p class="text-sm text-base-content/70">支持向量搜索和AI智能问答</p>
        </div>
        <div class="navbar-end">
            <!-- 主题切换 -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                    <li><a onclick="setTheme('dark')" class="font-bold">🌙 深色模式 (推荐)</a></li>
                    <li><a onclick="setTheme('light')">🌞 浅色模式</a></li>
                    <li><a onclick="setTheme('business')">💼 商务黑</a></li>
                    <li><a onclick="setTheme('night')">🌌 夜晚模式</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- 集合选择卡片 -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">
                    <i data-lucide="database"></i>
                    选择数据集合
                </h2>
                <div class="flex flex-wrap gap-2 mt-4" id="collections-container">
                    <div class="skeleton h-10 w-32"></div>
                    <div class="skeleton h-10 w-32"></div>
                </div>
                <div class="alert alert-info mt-4" id="collection-info" style="display: none;">
                    <i data-lucide="info"></i>
                    <span id="collection-details">请选择一个集合</span>
                </div>
            </div>
        </div>

        <!-- 查询模式选择 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- 向量搜索模式 -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer" 
                 onclick="setMode('vector')" id="vector-mode-card">
                <div class="card-body">
                    <h2 class="card-title text-primary">
                        <i data-lucide="search"></i>
                        向量搜索
                    </h2>
                    <p class="text-base-content/70">快速精确的相似性检索，找到最相关的内容</p>
                    <div class="card-actions justify-end">
                        <div class="badge badge-primary badge-outline">快速</div>
                        <div class="badge badge-primary badge-outline">精确</div>
                    </div>
                </div>
            </div>

            <!-- AI问答模式 -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer" 
                 onclick="setMode('llama')" id="llama-mode-card">
                <div class="card-body">
                    <h2 class="card-title text-secondary">
                        <i data-lucide="bot"></i>
                        AI问答
                    </h2>
                    <p class="text-base-content/70">自然语言智能对话，获得详细的答案解释</p>
                    <div class="card-actions justify-end">
                        <div class="badge badge-secondary badge-outline">智能</div>
                        <div class="badge badge-secondary badge-outline">详细</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查询界面 -->
        <div class="card bg-base-100 shadow-xl" id="query-interface" style="display: none;">
            <!-- 向量搜索界面 -->
            <div id="vector-search" style="display: none;">
                <div class="card-body">
                    <h2 class="card-title text-primary">
                        <i data-lucide="search"></i>
                        向量搜索
                    </h2>
                    
                    <!-- 搜索输入 -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">搜索内容</span>
                        </label>
                        <input type="text" id="vector-query" placeholder="输入搜索关键词..." 
                               class="input input-bordered input-primary w-full" />
                    </div>

                    <!-- 高级选项 -->
                    <div class="collapse collapse-arrow bg-base-200 mt-4">
                        <input type="checkbox" />
                        <div class="collapse-title text-sm font-medium">
                            <i data-lucide="settings"></i>
                            高级搜索选项
                        </div>
                        <div class="collapse-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">内容类型</span>
                                    </label>
                                    <select id="content-type" class="select select-bordered">
                                        <option value="">所有类型</option>
                                        <option value="paragraph">段落</option>
                                        <option value="heading_h1">一级标题</option>
                                        <option value="heading_h2">二级标题</option>
                                        <option value="heading_h3">三级标题</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">最小字数</span>
                                    </label>
                                    <input type="number" id="min-words" placeholder="如: 10" 
                                           class="input input-bordered" />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">结果数量</span>
                                    </label>
                                    <select id="top-k" class="select select-bordered">
                                        <option value="5">5条</option>
                                        <option value="10">10条</option>
                                        <option value="20">20条</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-actions justify-center mt-6">
                        <button onclick="vectorSearch()" class="btn btn-primary btn-wide">
                            <i data-lucide="search"></i>
                            开始搜索
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI问答界面 -->
            <div id="llama-chat" style="display: none;">
                <div class="card-body">
                    <h2 class="card-title text-secondary">
                        <i data-lucide="bot"></i>
                        AI智能问答
                    </h2>
                    
                    <!-- 聊天历史 -->
                    <div class="bg-base-200 rounded-lg p-4 h-96 overflow-y-auto mb-4" id="chat-history">
                        <div class="flex items-center justify-center h-full text-base-content/50">
                            <div class="text-center">
                                <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>开始您的智能问答...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 输入框 -->
                    <div class="join w-full">
                        <input type="text" id="chat-input" placeholder="请输入您的问题..." 
                               class="input input-bordered input-secondary join-item flex-1"
                               onkeypress="if(event.key==='Enter') chatQuery()" />
                        <button onclick="chatQuery()" class="btn btn-secondary join-item">
                            <i data-lucide="send"></i>
                            发送
                        </button>
                    </div>

                    <!-- 快捷问题 -->
                    <div class="mt-4">
                        <div class="label">
                            <span class="label-text">快捷问题：</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('関電工公司信息')">関電工公司信息</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('主要业务领域')">主要业务领域</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('公司历史')">公司历史</button>
                            <button class="btn btn-sm btn-outline" onclick="askQuestion('联系方式')">联系方式</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示 -->
        <div class="card bg-base-100 shadow-xl mt-6" id="results-container" style="display: none;">
            <div class="card-body">
                <h2 class="card-title">
                    <i data-lucide="file-text"></i>
                    查询结果
                </h2>
                <div id="results-content"></div>
            </div>
        </div>
    </div>

    <!-- 加载模态框 -->
    <dialog id="loading-modal" class="modal">
        <div class="modal-box text-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
            <h3 class="font-bold text-lg mt-4">处理中...</h3>
            <p class="py-4">请稍等，正在为您查询信息</p>
        </div>
    </dialog>

    <!-- Toast 通知容器 -->
    <div class="toast toast-top toast-end" id="toast-container"></div>

    <script>
        let currentCollection = null;
        let currentMode = null;

        // 初始化
        window.onload = function() {
            // 初始化 Lucide 图标
            lucide.createIcons();
            
            // 加载集合列表
            loadCollections();
            
            // 配置 marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
        };

        // 主题切换
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            showToast('主题已切换到 ' + theme, 'success');
        }

        // 从本地存储加载主题，默认为深色模式
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if (!localStorage.getItem('theme')) {
            localStorage.setItem('theme', 'dark');
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg`;
            toast.innerHTML = `
                <div>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 加载集合列表
        async function loadCollections() {
            try {
                const response = await axios.get('/api/collections');
                const collections = response.data.collections;
                const container = document.getElementById('collections-container');
                
                if (collections.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning"><span>未找到可用集合</span></div>';
                    return;
                }

                container.innerHTML = collections.map(name => 
                    `<button onclick="selectCollection('${name}')" 
                             class="btn btn-outline collection-btn" data-collection="${name}">
                        <i data-lucide="database"></i>
                        ${name}
                    </button>`
                ).join('');

                // 重新初始化图标
                lucide.createIcons();

                // 优先选择包含関電工数据的集合
                const preferredCollections = ['kandenko_website_smart', 'kandenko_website'];
                let selectedCollection = null;
                
                for (const preferred of preferredCollections) {
                    if (collections.includes(preferred)) {
                        selectedCollection = preferred;
                        break;
                    }
                }
                
                if (selectedCollection) {
                    selectCollection(selectedCollection);
                } else if (collections.length === 1) {
                    selectCollection(collections[0]);
                }
            } catch (error) {
                console.error('加载集合失败:', error);
                document.getElementById('collections-container').innerHTML = 
                    '<div class="alert alert-error"><span>加载集合失败</span></div>';
            }
        }

        // 选择集合
        async function selectCollection(collectionName) {
            currentCollection = collectionName;
            
            // 更新UI
            document.querySelectorAll('.collection-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            document.querySelector(`[data-collection="${collectionName}"]`).classList.remove('btn-outline');
            document.querySelector(`[data-collection="${collectionName}"]`).classList.add('btn-primary');

            // 获取集合信息
            try {
                const response = await axios.get(`/api/collections/${collectionName}/stats`);
                const stats = response.data;
                
                document.getElementById('collection-details').innerHTML = 
                    `已选择: <strong>${collectionName}</strong> | 记录数: ${stats.total_records} | 维度: ${stats.dimension}`;
                document.getElementById('collection-info').style.display = 'flex';
                
                showToast(`已选择集合: ${collectionName}`, 'success');
            } catch (error) {
                console.error('获取集合信息失败:', error);
                showToast('获取集合信息失败', 'error');
            }
        }

        // 设置查询模式
        function setMode(mode) {
            if (!currentCollection) {
                showToast('请先选择一个集合', 'warning');
                return;
            }

            currentMode = mode;
            
            // 重置卡片样式
            document.getElementById('vector-mode-card').classList.remove('bg-primary', 'text-primary-content');
            document.getElementById('llama-mode-card').classList.remove('bg-secondary', 'text-secondary-content');
            
            if (mode === 'vector') {
                document.getElementById('vector-mode-card').classList.add('bg-primary', 'text-primary-content');
                document.getElementById('vector-search').style.display = 'block';
                document.getElementById('llama-chat').style.display = 'none';
                showToast('已切换到向量搜索模式', 'info');
            } else {
                document.getElementById('llama-mode-card').classList.add('bg-secondary', 'text-secondary-content');
                document.getElementById('vector-search').style.display = 'none';
                document.getElementById('llama-chat').style.display = 'block';
                showToast('已切换到AI问答模式', 'info');
            }
            
            document.getElementById('query-interface').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
        }

        // 向量搜索
        async function vectorSearch() {
            const query = document.getElementById('vector-query').value.trim();
            if (!query) {
                showToast('请输入搜索内容', 'warning');
                return;
            }

            showLoading(true);
            
            try {
                const params = {
                    query: query,
                    collection_name: currentCollection,
                    content_type: document.getElementById('content-type').value || null,
                    min_words: document.getElementById('min-words').value || null,
                    top_k: parseInt(document.getElementById('top-k').value)
                };

                const response = await axios.post('/api/vector-search', params);
                displayVectorResults(response.data.results);
                showToast(`找到 ${response.data.results.length} 条相关结果`, 'success');
            } catch (error) {
                console.error('搜索失败:', error);
                showToast('搜索失败: ' + (error.response?.data?.error || error.message), 'error');
            } finally {
                showLoading(false);
            }
        }

        // AI问答
        async function chatQuery() {
            const question = document.getElementById('chat-input').value.trim();
            if (!question) return;

            // 添加用户消息到聊天历史
            addChatMessage('user', question);
            document.getElementById('chat-input').value = '';

            showLoading(true);

            try {
                const response = await axios.post('/api/llama-chat', {
                    question: question,
                    collection_name: currentCollection
                });

                addChatMessage('assistant', response.data.answer, response.data.sources);
            } catch (error) {
                console.error('AI问答失败:', error);
                addChatMessage('assistant', '抱歉，AI问答服务暂时不可用: ' + (error.response?.data?.error || error.message));
            } finally {
                showLoading(false);
            }
        }

        // 快捷问题
        function askQuestion(question) {
            document.getElementById('chat-input').value = question;
            chatQuery();
        }

        // 添加聊天消息 - 支持 Markdown
        function addChatMessage(role, content, sources = null) {
            const chatHistory = document.getElementById('chat-history');
            
            // 清空占位符
            const placeholder = chatHistory.querySelector('.flex.items-center.justify-center');
            if (placeholder) placeholder.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat ${role === 'user' ? 'chat-end' : 'chat-start'}`;
            
            let html = `
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full ${role === 'user' ? 'bg-primary' : 'bg-secondary'}">
                        <div class="flex items-center justify-center h-full text-white">
                            ${role === 'user' ? '<i data-lucide="user"></i>' : '<i data-lucide="bot"></i>'}
                        </div>
                    </div>
                </div>
                <div class="chat-header">
                    ${role === 'user' ? '您' : 'AI助手'}
                    <time class="text-xs opacity-50">${new Date().toLocaleTimeString()}</time>
                </div>
                <div class="chat-bubble ${role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-secondary'}">
                    <div class="prose prose-sm max-w-none text-inherit">
                        ${marked.parse(content)}
                    </div>
            `;
            
            if (sources && sources.length > 0) {
                html += `
                    <div class="collapse collapse-arrow mt-2">
                        <input type="checkbox" />
                        <div class="collapse-title text-xs opacity-75 p-0">
                            <i data-lucide="link"></i>
                            参考来源 (${sources.length})
                        </div>
                        <div class="collapse-content p-0 pt-2">
                            <div class="text-xs space-y-1">
                `;
                sources.forEach((source, i) => {
                    const title = source.title.substring(0, 50) + (source.title.length > 50 ? '...' : '');
                    const url = source.url || '#';
                    html += `
                        <div class="flex items-center gap-2 p-1 rounded bg-base-100/20">
                            <span class="badge badge-xs">${i+1}</span>
                            <span class="badge badge-outline badge-xs">${source.content_type}</span>
                            ${url && url !== '#' && url !== '' ? 
                                `<a href="${url}" target="_blank" class="link link-hover flex-1 truncate">${title}</a>` : 
                                `<span class="flex-1 truncate">${title}</span>`}
                            <span class="text-xs opacity-60">${source.similarity.toFixed(3)}</span>
                        </div>
                    `;
                });
                html += '</div></div></div>';
            }
            
            html += '</div>';
            messageDiv.innerHTML = html;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // 重新初始化图标
            lucide.createIcons();
        }

        // 显示向量搜索结果
        function displayVectorResults(results) {
            const container = document.getElementById('results-content');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><span>未找到相关结果</span></div>';
            } else {
                container.innerHTML = results.map((result, i) => `
                    <div class="card bg-base-200 shadow mb-4">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="card-title text-lg">
                                    <span class="badge badge-neutral">${i + 1}</span>
                                    ${result.title || '无标题'}
                                </h3>
                                <div class="badge badge-primary">${result.distance?.toFixed(3) || 'N/A'}</div>
                            </div>
                            
                            <div class="flex gap-2 mb-3">
                                <div class="badge badge-outline">${result.content_type || 'N/A'}</div>
                                ${result.url && result.url !== '#' && result.url !== '' ? 
                                    `<a href="${result.url}" target="_blank" class="badge badge-info badge-outline">
                                        <i data-lucide="external-link" class="w-3 h-3 mr-1"></i>
                                        查看原文
                                    </a>` : ''}
                            </div>
                            
                            <div class="prose prose-sm max-w-none">
                                ${marked.parse(result.content?.substring(0, 300) || '无内容')}
                                ${result.content?.length > 300 ? '<p class="text-base-content/50">...</p>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // 重新初始化图标
                lucide.createIcons();
            }
            
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }

        // 显示/隐藏加载模态框
        function showLoading(show) {
            const modal = document.getElementById('loading-modal');
            if (show) {
                modal.showModal();
            } else {
                modal.close();
            }
        }
    </script>
</body>
</html>